<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>envoy on Jing Lin‘s profile</title><link>http://linjing.io/tags/envoy/</link><description>Recent content in envoy on Jing Lin‘s profile</description><generator>Source Themes academia (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>Copyright &amp;copy; {year} linjing.io host on github, imesh.cloud host on netlify. CI/CD by github actions and netlify.Thanks bootcdn support for front libary CDN</copyright><lastBuildDate>Tue, 30 Jun 2020 00:00:00 +0000</lastBuildDate><atom:link href="http://linjing.io/tags/envoy/index.xml" rel="self" type="application/rss+xml"/><item><title>How an application delivery veteran see Envoy in the era of cloud native</title><link>http://linjing.io/post/f5-envoy-cloud-native/</link><pubDate>Tue, 30 Jun 2020 00:00:00 +0000</pubDate><guid>http://linjing.io/post/f5-envoy-cloud-native/</guid><description>&lt;h2 id="foreword">Foreword&lt;/h2>
&lt;p>Envoy, messenger, envoy, representative! Just like the meaning of the word itself, with a sense of authority, a sense of sacred full agent. Combined with its own use and role, it is really &amp;ldquo;people as their name&amp;rdquo;, can&amp;rsquo;t help but like Lyft, I don&amp;rsquo;t know which master got the name to get this name. In the current era of fiery microservices, Envoy is an absolute star, and it is no exaggeration to describe it as everyone knows. Someone once asked me how to look at Envoy and whether Envoy will replace F5 instead of NGINX in the cloud-native era. As a veteran who has experienced two waves of change in the field of application delivery technology, in this article I will talk about Envoy in the future From a perspective to understand and answer this question. Why talk a little bit, this is really not modesty, but objectively, there is really no such in-depth large-scale long-term use and research of all technical details of Envoy, so I will combine my professional experience and experience to make an Envoy Talk.&lt;/p>
&lt;h2 id="star-studded-envoy">Star-studded Envoy&lt;/h2>
&lt;p>First, let&amp;rsquo;s take a look at how Envoy officially introduced Envoy:&lt;/p>
&lt;blockquote>
&lt;p>ENVOY IS AN OPEN SOURCE EDGE AND SERVICE PROXY, DESIGNED FOR CLOUD-NATIVE APPLICATIONS&lt;/p>
&lt;/blockquote>
&lt;p>From this description on the homepage of the website, we can clearly see the official definition of Envoy, which is simply a proxy for east-west, north-south traffic in the cloud native era. Lfyt is the pioneer of the microservice application architecture. We can see Lfyt in a large number of microservice sermon articles. After a large-scale shift from monolithic applications to microservice architecture, a serious problem was placed in development. In front of the architects, on the one hand, Lyft&amp;rsquo;s services are developed in multiple languages, and the use of class libraries to solve various problems under the distributed architecture requires a lot of language adaptation and code intrusion. On the other hand, Lyft&amp;rsquo;s business Both are deployed on AWS, relying heavily on AWS&amp;rsquo; ELB and EC2, but the traffic control, insight, and problem elimination between the services provided by ELB and AWS at that time could not meet Lyft&amp;rsquo;s needs. It is based on this background, Lfyt is Envoy development started in May 2015. It was first deployed as an edge agent and began to replace ELB, and then began to be deployed as a sidecar method for large-scale deployment. On September 14, 2016, Lyft officially announced this project on its blog: Envoy C++ L7 proxy and communication bus . For a while, Envoy received a lot of attention, and companies such as Google began to contribute to this project, and donated the project to CNCF one year later in September 2017. With a good mom like Lyft, and the succession to CNCF as a rich dad, plus the half-brother Istio star brother&amp;rsquo;s blessing, it can be said that Envoy has a good scene for a while, earning enough eyeball and developer support, I graduated from CNCF in just over a year.&lt;/p>
&lt;p>Container technology has helped enterprises practice Devops and microservice transformation. The k8s container orchestration platform allows enterprises to move more business from traditional architectures to modern container-based infrastructures with more confidence. k8s solves container orchestration and applications. Issues such as publishing, but when the communication between services has changed from the previous call between memory to TCP-based network communication, the impact of the network on application services has become more huge and uncertain, based on traditional application architecture operation and maintenance The means cannot adapt and solve the huge and complex communication insights and troubleshooting between services. In order to solve such problems, the service mesh application was born and quickly became a hot topic of concern. The Istio project is the most important player in this ecosystem. Istio&amp;rsquo;s architecture is a typical management plane and data separation architecture. The choice of data plane is open, but Istio chooses Envoy as the data plane by default. The two popular stars joined forces to make Linkerd eclipsed almost at the same time. At this point in time, NGINX also briefly carried out the Nginmesh project, trying to make NGINX as the data plane of Istio, but eventually gave up at the end of 2018, why did you give up, this article will be mentioned later.&lt;/p>
&lt;p>In addition to Istio&amp;rsquo;s selection of Envoy as the data plane, there are many projects based on Envoy, such as multiple Ingress Controller projects of k8s: Gloo, Contur, Ambassador. Istio&amp;rsquo;s own Ingress gateway and Egress gateway also choose Envoy. Take a look at the Envoy users listed on their official homepage and say that starlight is not too much. Note that F5 in the list is very interesting.&lt;/p>
&lt;p>&lt;img src="envoy-endusers.jpg" alt="">
(Envoy end user list)&lt;/p>
&lt;h2 id="envoy-born-for-the-times">Envoy: born for the times&lt;/h2>
&lt;p>Below I will look at the technical aspects of why Envoy is so valued by the community. It will be summarized from the following aspects:&lt;/p>
&lt;ul>
&lt;li>Technical characteristics&lt;/li>
&lt;li>Deployment architecture&lt;/li>
&lt;li>Software Architecture&lt;/li>
&lt;/ul>
&lt;h3 id="technical-characteristics">Technical characteristics&lt;/h3>
&lt;ul>
&lt;li>Interface and API&lt;/li>
&lt;li>Dynamic&lt;/li>
&lt;li>Scalability&lt;/li>
&lt;li>Observability&lt;/li>
&lt;li>Modernity&lt;/li>
&lt;/ul>
&lt;h4 id="interface-and-api">Interface and API&lt;/h4>
&lt;p>When I first opened the configuration of Envoy, my first feeling was, God, how should such a product user configure and use. Under the intuitive experience, in an uncomplicated experimental environment, the number of lines of an Envoy&amp;rsquo;s actual configuration file actually reached 20,000 lines.&lt;/p>
&lt;pre>&lt;code># kubectl exec -it productpage-v1-7f4cc988c6-qxqjs -n istio-bookinfo -c istio-proxy -- sh
$ curl http://127.0.0.1:15000/config_dump | wc -l
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 634k 0 634k 0 0 10.1M 0 --:--:-- --:--:-- --:--:-- 10.1M
20550
&lt;/code>&lt;/pre>&lt;p>Although this is a dynamic configuration in the Istio environment, although there are ways to optimize it to reduce the actual configuration amount, or that we will not do such a large amount of configuration when using the static configuration method for configuration, but when we see the following actual The configuration structure output will feel that for such a software, it is obviously impractical to configure and maintain in a normal way. Its configuration is completely json structured and has a large number of descriptive configurations. Compared to NGINX and other such reverse For agent software, its configuration structure is too complicated.&lt;/p>
&lt;p>&lt;img src="envoy-json.jpg" alt="">
(Complex configuration structure)&lt;/p>
&lt;p>Obviously, Envoy&amp;rsquo;s design is not designed for manual, so Envoy designed a large number of xDS protocol interfaces, users need to design an xDS server to implement all configuration processing, Envoy supports gRPC or REST to communicate with the server to update Own configuration. xDS is the general name of the Envoy DS (discover service) protocol, which can be divided into Listener DS (LDS), Route DS (RDS), Cluster DS (CDS), Endpoint DS (EDS), and Secret DS in order to ensure consistent configuration DS-ADS of polymerization and the like, may be more xDS view here . These interfaces are used to automatically generate various specific configuration objects. It can be seen that this is a highly dynamic runtime configuration. To use it well, you must develop a server with sufficient capabilities. Obviously this is not the design thinking of traditional reverse proxy software.&lt;/p>
&lt;p>&lt;img src="envoy-xds.png" alt="">
(Picture from &lt;a href="https://gist.github.com/nikhilsuvarna/bd0aa0ef01880270c13d145c61a4af22">https://gist.github.com/nikhilsuvarna/bd0aa0ef01880270c13d145c61a4af22&lt;/a> )&lt;/p>
&lt;h4 id="dynamic">Dynamic&lt;/h4>
&lt;p>As mentioned earlier, Envoy&amp;rsquo;s configuration relies heavily on interface automation to generate various configurations. These configurations can be modified by Runtime without reloading files. In modern application architectures, the life cycle of a service endpoint becomes shorter and its operation Uncertainty or resilience has become greater, so the ability to make runtime changes to the configuration without having to reload the configuration file is particularly valuable in modern application architectures, which is an important consideration for Istio&amp;rsquo;s choice of Envoy as the data plane. Envoy also has a hot restart capability, which makes it more elegant when an upgrade or a restart is necessary, and existing connections can be protected more.&lt;/p>
&lt;p>In the Istio scenario, Envoy&amp;rsquo;s container runs two processes, one called pilot-agent and one is envoy-proxy itself. The pilot-agent is responsible for managing and starting Envoy, and generates an envoy under /etc/istio/proxy/ -rev0.json Initial configuration file, this file defines how Envoy should communicate with the pilot server to obtain the configuration, and use this configuration file to finally start the Envoy process. However, the final configuration of Envoy is not only the content in envoy-rev0.json, it contains all the dynamic configurations discovered through the xDS protocol mentioned above.&lt;/p>
&lt;pre>&lt;code># kubectl exec -it productpage-v1-7f4cc988c6-qxqjs -n istio-bookinfo -c istio-proxy -- sh
$ ps -ef
UID PID PPID C STIME TTY TIME CMD
istio-p+ 1 0 0 Jun25 ? 00:00:33 /usr/local/bin/pilot-agent proxy sidecar --domain istio-bookinfo.svc.cluster.local --serviceCluster productpage.istio-bookinfo --proxyLogLevel=warning --proxyComp
istio-p+ 14 1 0 Jun25 ? 00:05:31 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster productpage.istio-bookin
istio-p+ 142 0 0 15:38 pts/0 00:00:00 sh
istio-p+ 148 142 0 15:38 pts/0 00:00:00 ps -ef
&lt;/code>&lt;/pre>&lt;p>In the envoy overall configuration dump of the following figure, you can see that the contents of bootstrap and other static and dynamic configurations are included:&lt;/p>
&lt;p>&lt;img src="envoy-dump-config-json-struc.jpg.jpg" alt="">
(Envoy configuration structure)&lt;/p>
&lt;p>Combined with the following figure, you can see the basic Envoy configuration structure and its logic, whether it is an entrance listener (similar to F5&amp;rsquo;s VS and part of the profile configuration, NGINX&amp;rsquo;s listener and some Server paragraph configuration) or routing control logic (similar to F5 LTM policy, NGINX&amp;rsquo;s Various Locations matching, etc., or Clusters (similar to F5 pool, NGINX upstream), Endpoints (similar to F5 pool member, NGINX upstream server), and even SSL certificates can be automatically discovered from the service side through the interface&lt;/p>
&lt;p>&lt;img src="envoy-basic-objects-logic.png" alt="">
(picture (From &lt;a href="https://gist.github.com/nikhilsuvarna/bd0aa0ef01880270c13d145c61a4af22">https://gist.github.com/nikhilsuvarna/bd0aa0ef01880270c13d145c61a4af22&lt;/a> )&lt;/p>
&lt;h4 id="scalability">Scalability&lt;/h4>
&lt;p>A lot of filters can be seen in the configuration of Envoy. These are the performance of its scalability. Envoy learned the architecture of F5 and NGINX, and used a lot of plug-ins to make it easier for developers to develop. From the start of listener, it supports the use of filter, and supports developers to develop L3, L4, L7 plug-ins to achieve protocol expansion and more control.&lt;/p>
&lt;p>In practice, companies may not have as many C++ development reserves as languages ​​such as JavaScript, so Envoy also supports Lua and Webassembly extensions. This aspect eliminates the need to frequently recompile binaries and restart, and on the other hand reduces enterprise plug-in development. Difficulty, so that companies can use more Webassembly compatible languages ​​for plug-in writing, and then compile to Webassenmbly machine code to achieve efficient operation. At present, Envoy and Istio are still in the early stages of using Webassembly for expansion, and it will take some time to mature.&lt;/p>
&lt;p>&lt;img src="concept-envoy-filter.png" alt="">
(Picture from &lt;a href="https://www.servicemesher.com/istio-handbook/concepts/envoy.html">https://www.servicemesher.com/istio-handbook/concepts/envoy.html&lt;/a> )&lt;/p>
&lt;p>As can be seen from the above figure, such a request processing structure is very close to the design idea of ​​the F5 TMOS system, and is similar to NGINX to a certain extent. Connections and requests correspond to different processing components at different protocol levels and stages, and these components are themselves extensible and programmable, which in turn enables flexible programming control of the data flow.&lt;/p>
&lt;h4 id="observability">Observability&lt;/h4>
&lt;p>It is said that Envoy is born with the characteristics of cloud native. One of the characteristics is the emphasis on observability. You can see the three observable components: logs, metrics, and tracing are all supported by Envoy by default.&lt;/p>
&lt;p>Envoy allows users to define flexible log formats in flexible locations in a flexible manner. These changes can be delivered through dynamic configuration to achieve immediate effect, and allows the definition of sampling of logs. In Metrics, it provides many indicators that can be integrated with Prometheus. It is worth mentioning that Envoy allows the filter itself to expand these indicators. For example, in the filter such as current limiting or verification, the plug-in itself is allowed to define its own indicators to help users better. Use and quantify the operational status of the plugin. In terms of Tracing, Envoy supports integration with third parties such as zipkin, jaeger, datadog, lightStep, etc. Envoy can produce a uniform request ID and keep it spread throughout the network structure. It also supports external x-client-trace-id to achieve A description of the relationship topology between microservices.&lt;/p>
&lt;p>&lt;img src="envoy-kiali.jpg" alt="">&lt;/p>
&lt;p>Each span generated by Envoy contains the following data:&lt;/p>
&lt;ul>
&lt;li>Set by the &amp;ndash;service-clusteroriginal service cluster information.&lt;/li>
&lt;li>The start time and duration of the request.&lt;/li>
&lt;li>Set by the &amp;ndash;service-nodeoriginal host information.&lt;/li>
&lt;li>By x-envoy-downstream-service-clusterdownstream cluster header set.&lt;/li>
&lt;li>HTTP request URL, method, protocol and user agent.&lt;/li>
&lt;li>By custom_tagsanother custom label settings.&lt;/li>
&lt;li>The upstream cluster name and address.&lt;/li>
&lt;li>HTTP response status code.&lt;/li>
&lt;li>GRPC response status and messages (if available).&lt;/li>
&lt;li>Error flag when HTTP status is 5xx or GRPC status is not &amp;ldquo;OK&amp;rdquo;.&lt;/li>
&lt;li>Track system-specific metadata.&lt;/li>
&lt;/ul>
&lt;h4 id="modernity">Modernity&lt;/h4>
&lt;p>In fact, it is obviously correct nonsense to say that Envoy has modernity. Envoy was born for modern application architecture. Here we mainly want to explain from several aspects that we can most easily feel. The first is its special structural design. In Envoy, it supports the use of iptables to intercept the traffic and do transparent processing. It can use getsockopt () to extract the original destination information in the NAT entry, and allow listeners to listen on the listener. The transferred port listener jumps to an unbound listener that actually matches the original destination information. Although from the perspective of a reverse proxy, this is a bit like F5&amp;rsquo;s VS internal jump, NGINX&amp;rsquo;s subrequest, but its biggest feature and ability lies in transparent connection, which is especially important in the deployment Pod sidecar mode, refer to specific principles herein .&lt;/p>
&lt;p>For the gray-scale publishing, traffic mirroring, circuit breaker, global current limiting and other functions that are favorite for modern applications, its configuration is also very simple. Although F5/NGINX and other software can also accomplish similar tasks, they are native Envoy has greater advantages in terms of ease of configuration and ease of configuration.&lt;/p>
&lt;p>Another manifestation of modernity is the support of the protocol. Look at the following supported protocols. Students who are familiar with application delivery and reverse proxy software may not help but express their admiration. The support of these protocols on the other hand shows Envoy’s A feature that is more oriented towards developers and SRE.&lt;/p>
&lt;ul>
&lt;li>gRPC&lt;/li>
&lt;li>HTTP2&lt;/li>
&lt;li>MongoDB&lt;/li>
&lt;li>DynamoDB&lt;/li>
&lt;li>Redis&lt;/li>
&lt;li>Postgres&lt;/li>
&lt;li>Kafka&lt;/li>
&lt;li>Dubbo&lt;/li>
&lt;li>Thrift&lt;/li>
&lt;li>ZooKeeper&lt;/li>
&lt;li>RockeMQ&lt;/li>
&lt;/ul>
&lt;h3 id="deployment-architecture">Deployment architecture&lt;/h3>
&lt;p>After understanding the technical characteristics of Envoy, let&amp;rsquo;s look at Envoy from the perspective of deployment architecture.&lt;/p>
&lt;p>Complete Sidecar model deployment, which is the biggest deployment feature of Envoy. The communication between services is completely transformed into the communication between Envoy agents, so that many non-business functions are removed from the service code to external proxy components. Envoy is responsible for network communication control Observable with flow. It can also be deployed as a simplified sidecar, which only acts as a proxy for the inbound direction of service without additional traffic manipulation. This structure is used in the external observability based on NGINX to achieve business observability
&lt;img src="t1.jpg" alt="">&lt;/p>
&lt;p>Hub type, which is the same as the Router-mesh type concept in NGINX&amp;rsquo;s MRA. All services use a centralized Envoy to communicate. This deployment structure is generally suitable for small and medium-sized services. Service flow can be directed by adapting to service registration. To Envoy
&lt;img src="t2.jpg" alt="">&lt;/p>
&lt;p>Envoy can also be used as an Ingress edge gateway or Egress gateway. In this scenario, Envoy is generally used for Ingress controller or API gateway. You can see that many such implementations like to use Envoy as the underlying layer, such as Gloo, Ambassador, etc.
&lt;img src="t3.jpg" alt="">&lt;/p>
&lt;p>The following deployment structure should be familiar to everyone. As an Edge gateway, Envoy also deploys an additional layer of microservice gateway (or proxy platform layer)
&lt;img src="t5.jpg" alt="">&lt;/p>
&lt;p>Finally, this is to integrate all forms of Envoy deployment. This architecture may be in the middle of the process of migrating services from traditional architecture to microservice architecture
&lt;img src="t4.jpg" alt="">&lt;/p>
&lt;p>Ok, take a look at how Envoy is used in Istio
&lt;img src="t6.jpg" alt="">&lt;/p>
&lt;p>In summary, due to the cross-platform nature of Envoy, it has the same flexible deployment structure as NGINX, but in fact the deployment structure often has a strong relationship with the final configuration implementation mechanism, can the software&amp;rsquo;s ability adapt to the flexibility under this structure Implementation with simple configuration is the ultimate test. Objectively speaking, Envoy has an advantage in this respect.&lt;/p>
&lt;h3 id="software-architecture">Software Architecture&lt;/h3>
&lt;p>Envoy adopts a single-process multi-thread design structure, and the main thread is responsible for configuration updates and process signal processing. Requests are handled by multiple worker threads. In order to simplify and avoid processing complexity, a connection is always handled by one thread, which can minimize some lock operations caused by data sharing between threads. Envoy avoids state sharing between threads as much as possible, and designed the Thread Local Store mechanism for this purpose. In the log writing, the worker thread actually writes to the memory cache, and finally the file refresh thread is responsible for writing to the disk, which can improve efficiency to a certain extent. Overall, Envoy is still more focused on simplifying complexity and emphasizing flexibility, so unlike NGINX, it does not put the pursuit of performance in the first place, which can be obtained in the relevant official blog of Envoy verification.&lt;/p>
&lt;p>&lt;img src="envoy-thread.png" alt="">&lt;/p>
&lt;p>Similar to NGINX, Envoy is an asynchronous, non-blocking design, using an event-driven approach. Each thread is responsible for each listener, SO_REUSEPORT can also be used to share sockets, NGINX also has a similar mechanism.&lt;/p>
&lt;p>&lt;img src="t7.jpg" alt="">&lt;/p>
&lt;p>After the listener listens and starts processing, the connection will be processed by subsequent L3, 4, 7 and other filters according to the configuration.&lt;/p>
&lt;p>&lt;img src="envoy-arch.jpg" alt="">&lt;/p>
&lt;h2 id="f5nginx-the-sword-is-not-out">F5/NGINX: the sword is not out&lt;/h2>
&lt;p>After understanding the technical characteristics and architecture of Envoy, we return to the original point of this article. Envoy has been carrying the genes of modern application architecture from birth, does it mean that these front waves such as NGINX/F5 are out of date.&lt;/p>
&lt;p>I remember the author of NGINX, Igor, at the F5 China 520 conference to explain why NGINX is so successful. He said that he did not expect to be so successful because the reason is that he developed the right software at the right time. We know that during the period around 2003, there was still no talk about distributed architecture and microservices. At that time, the main problem to be solved was stand-alone performance. Based on this background, NGINX is strict in terms of architecture design and code quality. Demanding performance. In terms of functionality, NGINX was originally a Web Server software, L7 reverse proxy is an extension of its capabilities, and L4 proxy capabilities increase even later. In view of this background, from the perspective of modern application architecture, there are indeed some Capability is more difficult to cover. Similarly, Envoy was born and developed in the era of modern application architecture. As Envoy self-explained, it refers to a large number of existing hardware and software reverse proxy and load balancing products. From the above technical analysis, it can also be seen that Envoy has many NGINX and F5 Architectural concept, it can be said that Envoy draws many essences from mature reverse proxy products, and fully considers the needs of modern application architecture when designing, it is also a correct software at the right time.&lt;/p>
&lt;p>Under the microservices architecture, many problems have become how to control the communication and traffic insights between services. This is a typical application delivery field. As a frontier in this field, on the one hand, we must actively embrace and adapt to the new era of application architecture. On the one hand Need to innovate and continue to lead new directions. There have been two technological innovations in this field in history. The first was around 2006, when the topic of &amp;ldquo;load balancing was dead&amp;rdquo; was fired. The essence was that the market began to change at that time, and everyone was no longer satisfied with simple loads. Balanced, demand is derived from more complex scenarios such as application security, network optimization, application optimization, access control, and flow control. The concept of application delivery began to be proposed. It can be said that before 2006, the main concepts and technical directions of the market were based on The four-layer switch is the core concept of load balancing technology. Most players are traditional network manufacturers. The thinking and concepts are based on network switching. F5 is like a strange guy. The product design thinking is completely on another dimension. The TMOS V9 operating system, which has been released since 2004, has led the market since then, and no one has surpassed it for 10 years thereafter. The second technological innovation occurred around 2016. Affected by the cloud and microservices, software and lightweight became the mainstream of the market. At the same time, Devops thought means that the role of users has changed. The traditional design for network operation and maintenance personnel It began to become difficult to meet market demand. The field dominated by F5 has also undergone new changes in the market. Gartner no longer publishes magic quadrant analysis in the field of application delivery, and instead forms guidance in the way of Guide.&lt;/p>
&lt;p>&lt;img src="F5-stock.jpeg" alt="">&lt;/p>
&lt;p>Looking at the present, history is always surprisingly similar.&lt;/p>
&lt;p>The modern application architecture is developing rapidly, and a large number of applications are beginning to be micro-serviced. However, from the perspective of the overall chain of business access, Envoy cannot solve all problems, such as application security protection, complex enterprise protocols, and different needs caused by different organizational relationships. It can be seen that the application delivery products represented by F5/NGINX have also begun to actively realize product integration under the Devops tide. F5 has released a complete automated tool chain, from the product’s bootstrap to network configuration, to application service configuration, to the final Monitoring and telemetry have formed a complete interface, and use declarative interface to promote product management to a higher role crowd and management system. NGINX also builds its own API and Controller plane, and provides a declarative API interface to the outside world. Developers can better use the interface to integrate into their own control plane. These changes are for developers or SRE to better use F5/NGINX. For details, please refer to my &amp;ldquo;From Traditional ADC to Cloud Native ADC&amp;rdquo; &lt;a href="https://mp.weixin.qq.com/s?src=11&amp;amp;timestamp=1593224168&amp;amp;ver=2425&amp;amp;signature=znUdlLDdpbGGxWX7pZhH2uSVq1SAdQuloO09HIXssdQ15nRtWVOIgzlYTFmjOIUsDrqghPbSZM6vQI45TIqmINQKjposI7AfJ6jKQaEXm9KD4tEV5Bk9AF0RGuKvVuHI&amp;amp;new=1">series of articles&lt;/a>.&lt;/p>
&lt;p>&lt;img src="slides-3.jpg" alt="">&lt;/p>
&lt;p>After acquiring NGINX and Shape, F5 put forward a new view that will make full use of the widely accessible data plane capabilities, and use AI to further tap the data potential to help users better grasp and understand application behavior and performance, and provide references for business operations. , And feedback to component configuration and operation management to form a closed loop.&lt;/p>
&lt;p>An important scenario for modern application delivery is still indispensable, that is, application security. Although Istio and other products have made many attempts in secure communication, identity, and strategy, application security itself is relatively lacking. F5 is a leading manufacturer in the field of WAF security Through the transfer of security capabilities to NGINX, a new NGINX APP Protect is formed, which uses its cross-platform capabilities to help users better manage application security capabilities in microservice scenarios and help enterprises better implement DevSecOps.&lt;/p>
&lt;p>If we compare the technical features of Envoy with F5, we can see that F5 lacks scalability and modernity to a certain extent. F5 has good programming control capabilities, but it is relatively larger than the development of larger plug-ins. Insufficient, this and modernity can often be linked together. For example, if you want to make a complex 7-layer filter similar to Envoy for a very new protocol, it is impossible to achieve, although iRule or iRuleLX can do something to a certain extent. However, in any case, the final product form of F5 itself determines that F5&amp;rsquo;s BIGIP cannot be completely cross-platform, because it cannot run as a container. It is worth expecting that such morphological restrictions will be broken by F5&amp;rsquo;s next-generation TMOS system.&lt;/p>
&lt;p>Service Mesh is the current popular technology direction. F5 builds an enterprise-level Aspen Mesh service mesh product based on Istio, which helps enterprises deploy and use Istio better and easier. Aspen mesh team members enter the Istio Technical Oversight Committee with only 7 positions and are responsible for the important responsibilities of Istio&amp;rsquo;s RFCs/Designs/APIs. Although Istio has absolute ecology and popularity in the field of service mesh, this does not mean that Istio is the only choice. In many cases, customers may want to adopt a more concise Service Mesh to achieve most of the required functions instead of deploying one. The entire complex Istio solution, NGINX Service Mesh (NSM) based on NGINX components will bring new choices to users, a more simple and easy to use Service Mesh product, this is the reason why we mentioned NGINX to terminate Nginmesh at the beginning of the article .&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>Technology development is an inevitable process. In 2006, it evolved from traditional load balancing technology to application delivery. In addition to load balancing, it introduced many aspects such as security, access control, access control, and flow control. Around 2016, new technological changes have occurred in this field again. The emergence of a large number of new generation reverse proxy open source software has a new impact on traditional application delivery products. Active adaptation and change and innovation are the key to winning. Envoy has excellent capabilities as a new representative, but it is not a silver bullet to solve all problems. Envoy has a steeper learning curve and higher development and maintenance costs. For enterprises, they should choose the appropriate solution and Products to solve different problems in the architecture, to avoid catching the trend and let yourself fall into the trap.&lt;/p>
&lt;p>F5 needs more to let developers understand the huge potential of TMOS system (especially the subversion of the next generation products in architecture and form), understand its excellent all-agent architecture and program control at any level, so that developers, SRE develops with F5 TMOS as a capability platform and middleware, and better utilizes F5&amp;rsquo;s own application delivery capabilities to quickly realize its own needs.&lt;/p>
&lt;p>Finally, again quote a sentence from the homepage of the official Envoy website:&lt;/p>
&lt;blockquote>
&lt;p>As microservice practitioners soon realized, most of the operational problems that arise when moving to a distributed architecture are ultimately based on two aspects: network and observability.&lt;/p>
&lt;/blockquote>
&lt;p>And to ensure more reliable network delivery and better observability is the strength of Qianlang. Innovate, Qianlang.&lt;/p>
&lt;p>Written at the end: No matter how the technology changes, the human factor is still the core, regardless of the company or the manufacturer, in such a wave of technology, it should have sufficient technical reserves, just like the traditional financial industry through the establishment of technology companies to seek transformation, Manufacturers also need to be transformed. F5 China&amp;rsquo;s SE has almost 100% passed the CKA certification. Regardless of the relative proportion or absolute number, it should be unique in the industry. The transformation is not only in products, but also in thinking.&lt;/p>
&lt;p>Check more istio practice detail at my tech blog &lt;a href="https://cnadn.net">https://cnadn.net&lt;/a>&lt;/p></description></item><item><title>What changes does envoy bring to ADN</title><link>http://linjing.io/publication/envoy-2020-6/</link><pubDate>Tue, 30 Jun 2020 00:00:00 +0000</pubDate><guid>http://linjing.io/publication/envoy-2020-6/</guid><description>&lt;!-- raw HTML omitted -->
&lt;p>Check here for full article &lt;a href="https://www.servicemesher.com/blog/thoughts-to-envoy-from-adn-perspective/">The link&lt;/a>.&lt;/p></description></item><item><title>Istio sidecar iptables and traffic steering detail</title><link>http://linjing.io/post/istio-traffic-control-deepdive/</link><pubDate>Thu, 25 Jun 2020 00:00:00 +0000</pubDate><guid>http://linjing.io/post/istio-traffic-control-deepdive/</guid><description>&lt;h2 id="istio-injected-iptables">Istio injected iptables&lt;/h2>
&lt;p>Istio implements the hijacking and processing of traffic by injecting the init container and envoy proxy container into the business pod. After the init container runs, the following NAT table rules for iptables will be generated in the corresponding linux namespace&lt;/p>
&lt;pre>&lt;code>&amp;amp;#91;root@k8s-node1-v1-16 ~]# iptables -t nat -L -v
Chain PREROUTING (policy ACCEPT 192K packets, 12M bytes)
pkts bytes target prot opt in out source destination
192K 12M ISTIO_INBOUND tcp -- any any anywhere anywhere
Chain INPUT (policy ACCEPT 192K packets, 12M bytes)
pkts bytes target prot opt in out source destination
Chain OUTPUT (policy ACCEPT 40673 packets, 3694K bytes)
pkts bytes target prot opt in out source destination
8917 535K ISTIO_OUTPUT tcp -- any any anywhere anywhere
Chain POSTROUTING (policy ACCEPT 40673 packets, 3694K bytes)
pkts bytes target prot opt in out source destination
Chain ISTIO_INBOUND (1 references)
pkts bytes target prot opt in out source destination
0 0 RETURN tcp -- any any anywhere anywhere tcp dpt:ssh
356 21360 RETURN tcp -- any any anywhere anywhere tcp dpt:15090
192K 11M RETURN tcp -- any any anywhere anywhere tcp dpt:15021
0 0 RETURN tcp -- any any anywhere anywhere tcp dpt:15020
34 2040 ISTIO_IN_REDIRECT tcp -- any any anywhere anywhere
Chain ISTIO_IN_REDIRECT (3 references)
pkts bytes target prot opt in out source destination
34 2040 REDIRECT tcp -- any any anywhere anywhere redir ports 15006
Chain ISTIO_OUTPUT (1 references)
pkts bytes target prot opt in out source destination
0 0 RETURN all -- any lo 127.0.0.6 anywhere
0 0 ISTIO_IN_REDIRECT all -- any lo anywhere !localhost owner UID match 1337
0 0 RETURN all -- any lo anywhere anywhere ! owner UID match 1337
8917 535K RETURN all -- any any anywhere anywhere owner UID match 1337
0 0 ISTIO_IN_REDIRECT all -- any lo anywhere !localhost owner GID match 1337
0 0 RETURN all -- any lo anywhere anywhere ! owner GID match 1337
0 0 RETURN all -- any any anywhere anywhere owner GID match 1337
0 0 RETURN all -- any any anywhere localhost
0 0 ISTIO_REDIRECT all -- any any anywhere anywhere
Chain ISTIO_REDIRECT (1 references)
pkts bytes target prot opt in out source destination
0 0 REDIRECT tcp -- any any anywhere anywhere redir ports 15001
&lt;/code>&lt;/pre>&lt;h2 id="outbound-flow-control">Outbound flow control&lt;/h2>
&lt;p>When the business container sends the request to the outside, such as productpage to reviews: 9080 port access, this connection will be redirected by iptables to port 127.0.0.1:115001, and then processed by envoy.&lt;/p>
&lt;blockquote>
&lt;p>REDIRECT
This target is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only called from those chains. It redirects the packet to the machine itself by changing the destination IP to the primary address of the incoming interface (locally-generated packets are mapped to the localhost address, 127.0.0.1 for IPv4 and ::1 for IPv6).&lt;/p>
&lt;p>&lt;a href="https://ipset.netfilter.org/iptables-extensions.man.html#lbDK">https://ipset.netfilter.org/iptables-extensions.man.html#lbDK&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>The virtualOutbound in envoy will be hit. This is a special listener. It contains the Original Destination listener filter. Note &amp;ldquo;useOriginalDst&amp;rdquo;: truethat after such configuration in the following configuration , envoy will re-find the matching listener in the configuration. If found, press the hit. The listener performs follow-up processing. If it cannot find it, it sends the request to the cluster in this listener. Here is a passthrough cluster. This cluster will forward the packet directly to the fourth layer.&lt;/p>
&lt;pre>&lt;code>root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 15001 -o json
&amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;virtualOutbound&amp;quot;,
&amp;quot;address&amp;quot;: {
&amp;quot;socketAddress&amp;quot;: {
&amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;portValue&amp;quot;: 15001
}
},
&amp;quot;filterChains&amp;quot;: &amp;amp;#91;
{
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_outbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_outbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
&amp;quot;cluster&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
]
}
}
],
&amp;quot;name&amp;quot;: &amp;quot;virtualOutbound-catchall-tcp&amp;quot;
}
],
&amp;quot;useOriginalDst&amp;quot;: true,
&amp;quot;trafficDirection&amp;quot;: &amp;quot;OUTBOUND&amp;quot;
}
]
&lt;/code>&lt;/pre>&lt;p>The above listener will hand over the connection to the listener that matches the original destination IP and port. In the bookinfo example, it will be handed over to the 9080 listener. There is a question to consider here. From the perspective of envoy, the destination port of this link is already 15001, why can it match the following port 0.0.0.0:9080. This is because the NAT is done in the system kernel when iptables is redirected. The system kernel has this converted storage. Envoy obtains the real destination port through getsockopt() , so that it can correctly match the business listener.&lt;/p>
&lt;pre>&lt;code>&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 9080 -o json
&amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;0.0.0.0_9080&amp;quot;,
&amp;quot;address&amp;quot;: {
&amp;quot;socketAddress&amp;quot;: {
&amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;portValue&amp;quot;: 9080
}
},
&amp;quot;filterChains&amp;quot;: &amp;amp;#91;
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;http/1.0&amp;quot;,
&amp;quot;http/1.1&amp;quot;,
&amp;quot;h2c&amp;quot;
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;outbound_0.0.0.0_9080&amp;quot;,
&amp;quot;rds&amp;quot;: {
&amp;quot;configSource&amp;quot;: {
&amp;quot;ads&amp;quot;: {}
},
&amp;quot;routeConfigName&amp;quot;: &amp;quot;9080&amp;quot;
},
&lt;/code>&lt;/pre>&lt;pre>&lt;code>&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo
ADDRESS PORT TYPE
10.102.252.88 15012 TCP
10.96.122.225 31400 TCP
10.96.0.10 53 TCP
10.110.88.185 15443 TCP
10.96.122.225 15443 TCP
10.110.88.185 443 TCP
10.102.252.88 443 TCP
10.106.109.172 9001 TCP
10.96.0.1 443 TCP
10.96.122.225 443 TCP
10.106.109.172 9000 TCP
10.105.130.171 14267 HTTP+TCP
10.96.81.27 5601 HTTP+TCP
0.0.0.0 15014 HTTP+TCP
10.105.130.171 14250 HTTP+TCP
0.0.0.0 20001 HTTP+TCP
0.0.0.0 9411 HTTP+TCP
10.111.37.34 9090 HTTP+TCP
10.105.145.36 80 HTTP+TCP
10.105.130.171 14268 HTTP+TCP
10.96.0.10 9153 HTTP+TCP
10.110.244.188 80 HTTP+TCP
10.102.252.88 853 HTTP+TCP
10.99.139.251 16686 HTTP+TCP
0.0.0.0 12345 HTTP+TCP
10.103.155.149 80 HTTP+TCP
0.0.0.0 8000 HTTP+TCP
0.0.0.0 15010 HTTP+TCP
10.96.122.225 15020 HTTP+TCP
0.0.0.0 9090 HTTP+TCP
10.107.150.251 80 HTTP+TCP
0.0.0.0 14250 HTTP+TCP
0.0.0.0 80 HTTP+TCP
0.0.0.0 3000 HTTP+TCP
10.110.28.96 8181 HTTP+TCP
10.102.69.143 9200 HTTP+TCP
0.0.0.0 9080 HTTP+TCP 《《《《《《《《《《《《
0.0.0.0 15001 TCP 《《《《《《《《《《《《
0.0.0.0 15006 HTTP+TCP
0.0.0.0 15090 HTTP
0.0.0.0 15021 HTTP
&lt;/code>&lt;/pre>&lt;p>Related passthrough cluster:&lt;/p>
&lt;pre>&lt;code>root@k8s-master-v1-16 ~]# istioctl proxy-config cluster productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --fqdn PassthroughCluster -o json
&amp;amp;#91;
。。。。忽略。。。
{
&amp;quot;name&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
&amp;quot;type&amp;quot;: &amp;quot;ORIGINAL_DST&amp;quot;,
&amp;quot;connectTimeout&amp;quot;: &amp;quot;10s&amp;quot;,
&amp;quot;lbPolicy&amp;quot;: &amp;quot;CLUSTER_PROVIDED&amp;quot;,
&amp;quot;circuitBreakers&amp;quot;: {
&amp;quot;thresholds&amp;quot;: &amp;amp;#91;
{
&amp;quot;maxConnections&amp;quot;: 4294967295,
&amp;quot;maxPendingRequests&amp;quot;: 4294967295,
&amp;quot;maxRequests&amp;quot;: 4294967295,
&amp;quot;maxRetries&amp;quot;: 4294967295
}
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
}
]
}
]
&lt;/code>&lt;/pre>&lt;h2 id="inbound-flow-control">Inbound flow control&lt;/h2>
&lt;p>When it is an inbound request, the destination address of the packet is the IP of the pod, and the destination port is the real port of the business (9080, non-svc mapping port). Since the link destination port of iptables is changed to 15006, it will Hit virtual inbound listener (0.0.0.0:15006), this listener has a series of filterchain, and the virtualoutbound listener configuration method is different, virtualinbound contains a series of actual service filters for specific ports, the connection will find specific in these fitlers Business matching. So how does it match the real 9080 business? For example, the following output:
addressPrefix can be matched. If the pod actually has multiple ports, only addressPrefix does not match. It also needs to match the application layer protocol, but the DestinationPort in the Match condition is not matched . In fact, it is similar to Virtualoutbound. The filter of the original destination listener is also used, so envoy will obtain the real destination port and IP from the kernel. This configuration method is different from the virtual outbound &amp;ldquo;useOriginalDst&amp;rdquo;: true configuration method, because this is an updated configuration method.&amp;rdquo; useOriginalDst&amp;rdquo;: true This configuration is about to be abandoned.&lt;/p>
&lt;p>&lt;code>&amp;quot;listenerFilters&amp;quot;: [ { &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.original_dst&amp;quot;, &amp;quot;typedConfig&amp;quot;: { &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.original_dst.v2.OriginalDst&amp;quot; } },&lt;/code>&lt;/p>
&lt;p>(According to &lt;a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener_components.proto,">https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener_components.proto,&lt;/a> the filtermatch condition is that all must match)&lt;/p>
&lt;pre>&lt;code> {
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;destinationPort&amp;quot;: 9080,
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.138&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 32
}
],
### 根据https://istio.io/latest/zh/docs/ops/deployment/requirements/ ,
### 同一个业务端口是不能被两个用不同协议的svc来发布的，因此这帮助避免了同端口同协议的match在整个配置文件里的出现。
&amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;istio&amp;quot;,
&amp;quot;istio-http/1.0&amp;quot;,
&amp;quot;istio-http/1.1&amp;quot;,
&amp;quot;istio-h2&amp;quot;
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.138_9080&amp;quot;,
&amp;quot;routeConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
&amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
&amp;quot;domains&amp;quot;: &amp;amp;#91;
&amp;quot;*&amp;quot;
],
&amp;quot;routes&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;match&amp;quot;: {
&amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
},
&amp;quot;route&amp;quot;: {
&amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
&amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
},
&amp;quot;decorator&amp;quot;: {
&amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
}
}
]
}
],
&lt;/code>&lt;/pre>&lt;h2 id="last">Last&lt;/h2>
&lt;p>Attach the actual configuration of 15006&lt;/p>
&lt;pre>&lt;code>&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 15006 -o json
&amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;,
&amp;quot;address&amp;quot;: {
&amp;quot;socketAddress&amp;quot;: {
&amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;portValue&amp;quot;: 15006
}
},
&amp;quot;filterChains&amp;quot;: &amp;amp;#91;
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 0
}
],
&amp;quot;transportProtocol&amp;quot;: &amp;quot;tls&amp;quot;,
&amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;istio-peer-exchange&amp;quot;,
&amp;quot;istio&amp;quot;
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
]
}
}
],
&amp;quot;transportSocket&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
&amp;quot;commonTlsContext&amp;quot;: {
&amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;sdsConfig&amp;quot;: {
&amp;quot;apiConfigSource&amp;quot;: {
&amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
&amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
{
&amp;quot;envoyGrpc&amp;quot;: {
&amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
}
}
]
}
}
}
],
&amp;quot;combinedValidationContext&amp;quot;: {
&amp;quot;defaultValidationContext&amp;quot;: {},
&amp;quot;validationContextSdsSecretConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
&amp;quot;sdsConfig&amp;quot;: {
&amp;quot;apiConfigSource&amp;quot;: {
&amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
&amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
{
&amp;quot;envoyGrpc&amp;quot;: {
&amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
}
}
]
}
}
}
},
&amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;istio-peer-exchange&amp;quot;,
&amp;quot;h2&amp;quot;,
&amp;quot;http/1.1&amp;quot;
]
},
&amp;quot;requireClientCertificate&amp;quot;: true
}
},
&amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;
},
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 0
}
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
]
}
}
],
&amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;
},
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 0
}
],
&amp;quot;transportProtocol&amp;quot;: &amp;quot;tls&amp;quot;,
&amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;http/1.0&amp;quot;,
&amp;quot;http/1.1&amp;quot;,
&amp;quot;h2c&amp;quot;,
&amp;quot;istio-http/1.0&amp;quot;,
&amp;quot;istio-http/1.1&amp;quot;,
&amp;quot;istio-h2&amp;quot;
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;routeConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;inbound|http|0&amp;quot;,
&amp;quot;domains&amp;quot;: &amp;amp;#91;
&amp;quot;*&amp;quot;
],
&amp;quot;routes&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;match&amp;quot;: {
&amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
},
&amp;quot;route&amp;quot;: {
&amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
},
&amp;quot;decorator&amp;quot;: {
&amp;quot;operation&amp;quot;: &amp;quot;:0/*&amp;quot;
}
}
]
}
],
&amp;quot;validateClusters&amp;quot;: false
},
&amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
}
}
],
&amp;quot;tracing&amp;quot;: {
&amp;quot;clientSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;randomSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;overallSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
}
},
&amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
&amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
],
&amp;quot;useRemoteAddress&amp;quot;: false,
&amp;quot;generateRequestId&amp;quot;: true,
&amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
&amp;quot;setCurrentClientCertDetails&amp;quot;: {
&amp;quot;subject&amp;quot;: true,
&amp;quot;dns&amp;quot;: true,
&amp;quot;uri&amp;quot;: true
},
&amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
}
],
&amp;quot;normalizePath&amp;quot;: true
}
}
],
&amp;quot;transportSocket&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
&amp;quot;commonTlsContext&amp;quot;: {
&amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;sdsConfig&amp;quot;: {
&amp;quot;apiConfigSource&amp;quot;: {
&amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
&amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
{
&amp;quot;envoyGrpc&amp;quot;: {
&amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
}
}
]
}
}
}
],
&amp;quot;combinedValidationContext&amp;quot;: {
&amp;quot;defaultValidationContext&amp;quot;: {},
&amp;quot;validationContextSdsSecretConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
&amp;quot;sdsConfig&amp;quot;: {
&amp;quot;apiConfigSource&amp;quot;: {
&amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
&amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
{
&amp;quot;envoyGrpc&amp;quot;: {
&amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
}
}
]
}
}
}
},
&amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;h2&amp;quot;,
&amp;quot;http/1.1&amp;quot;
]
},
&amp;quot;requireClientCertificate&amp;quot;: true
}
},
&amp;quot;name&amp;quot;: &amp;quot;virtualInbound-catchall-http&amp;quot;
},
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 0
}
],
&amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;http/1.0&amp;quot;,
&amp;quot;http/1.1&amp;quot;,
&amp;quot;h2c&amp;quot;
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;routeConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;inbound|http|0&amp;quot;,
&amp;quot;domains&amp;quot;: &amp;amp;#91;
&amp;quot;*&amp;quot;
],
&amp;quot;routes&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;match&amp;quot;: {
&amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
},
&amp;quot;route&amp;quot;: {
&amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
&amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
},
&amp;quot;decorator&amp;quot;: {
&amp;quot;operation&amp;quot;: &amp;quot;:0/*&amp;quot;
}
}
]
}
],
&amp;quot;validateClusters&amp;quot;: false
},
&amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
}
}
],
&amp;quot;tracing&amp;quot;: {
&amp;quot;clientSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;randomSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;overallSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
}
},
&amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
&amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
],
&amp;quot;useRemoteAddress&amp;quot;: false,
&amp;quot;generateRequestId&amp;quot;: true,
&amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
&amp;quot;setCurrentClientCertDetails&amp;quot;: {
&amp;quot;subject&amp;quot;: true,
&amp;quot;dns&amp;quot;: true,
&amp;quot;uri&amp;quot;: true
},
&amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
}
],
&amp;quot;normalizePath&amp;quot;: true
}
}
],
&amp;quot;name&amp;quot;: &amp;quot;virtualInbound-catchall-http&amp;quot;
},
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;destinationPort&amp;quot;: 15021,
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 32
}
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;inbound|15021|mgmt-15021|mgmtCluster&amp;quot;,
&amp;quot;cluster&amp;quot;: &amp;quot;inbound|15021|mgmt-15021|mgmtCluster&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
]
}
}
],
&amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_15021&amp;quot;
},
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;destinationPort&amp;quot;: 9080,
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 32
}
],
&amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;istio&amp;quot;,
&amp;quot;istio-http/1.0&amp;quot;,
&amp;quot;istio-http/1.1&amp;quot;,
&amp;quot;istio-h2&amp;quot;
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.155_9080&amp;quot;,
&amp;quot;routeConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
&amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
&amp;quot;domains&amp;quot;: &amp;amp;#91;
&amp;quot;*&amp;quot;
],
&amp;quot;routes&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;match&amp;quot;: {
&amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
},
&amp;quot;route&amp;quot;: {
&amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
&amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
},
&amp;quot;decorator&amp;quot;: {
&amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
}
}
]
}
],
&amp;quot;validateClusters&amp;quot;: false
},
&amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio_authn&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/istio.envoy.config.filter.http.authn.v2alpha1.FilterConfig&amp;quot;,
&amp;quot;policy&amp;quot;: {
&amp;quot;peers&amp;quot;: &amp;amp;#91;
{
&amp;quot;mtls&amp;quot;: {
&amp;quot;mode&amp;quot;: &amp;quot;PERMISSIVE&amp;quot;
}
}
]
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
}
}
],
&amp;quot;tracing&amp;quot;: {
&amp;quot;clientSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;randomSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;overallSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
}
},
&amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
&amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
],
&amp;quot;useRemoteAddress&amp;quot;: false,
&amp;quot;generateRequestId&amp;quot;: true,
&amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
&amp;quot;setCurrentClientCertDetails&amp;quot;: {
&amp;quot;subject&amp;quot;: true,
&amp;quot;dns&amp;quot;: true,
&amp;quot;uri&amp;quot;: true
},
&amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
}
],
&amp;quot;normalizePath&amp;quot;: true
}
}
],
&amp;quot;transportSocket&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
&amp;quot;commonTlsContext&amp;quot;: {
&amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;sdsConfig&amp;quot;: {
&amp;quot;apiConfigSource&amp;quot;: {
&amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
&amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
{
&amp;quot;envoyGrpc&amp;quot;: {
&amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
}
}
]
}
}
}
],
&amp;quot;combinedValidationContext&amp;quot;: {
&amp;quot;defaultValidationContext&amp;quot;: {},
&amp;quot;validationContextSdsSecretConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
&amp;quot;sdsConfig&amp;quot;: {
&amp;quot;apiConfigSource&amp;quot;: {
&amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
&amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
{
&amp;quot;envoyGrpc&amp;quot;: {
&amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
}
}
]
}
}
}
},
&amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
&amp;quot;h2&amp;quot;,
&amp;quot;http/1.1&amp;quot;
]
},
&amp;quot;requireClientCertificate&amp;quot;: true
}
},
&amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_9080&amp;quot;
},
{
&amp;quot;filterChainMatch&amp;quot;: {
&amp;quot;destinationPort&amp;quot;: 9080,
&amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
{
&amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
&amp;quot;prefixLen&amp;quot;: 32
}
]
},
&amp;quot;filters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
&amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.155_9080&amp;quot;,
&amp;quot;routeConfig&amp;quot;: {
&amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
&amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
&amp;quot;domains&amp;quot;: &amp;amp;#91;
&amp;quot;*&amp;quot;
],
&amp;quot;routes&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
&amp;quot;match&amp;quot;: {
&amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
},
&amp;quot;route&amp;quot;: {
&amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
&amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
},
&amp;quot;decorator&amp;quot;: {
&amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
}
}
]
}
],
&amp;quot;validateClusters&amp;quot;: false
},
&amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio_authn&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/istio.envoy.config.filter.http.authn.v2alpha1.FilterConfig&amp;quot;,
&amp;quot;policy&amp;quot;: {
&amp;quot;peers&amp;quot;: &amp;amp;#91;
{
&amp;quot;mtls&amp;quot;: {
&amp;quot;mode&amp;quot;: &amp;quot;PERMISSIVE&amp;quot;
}
}
]
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
&amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
&amp;quot;value&amp;quot;: {
&amp;quot;config&amp;quot;: {
&amp;quot;configuration&amp;quot;: &amp;quot;{\n \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
&amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
&amp;quot;vm_config&amp;quot;: {
&amp;quot;code&amp;quot;: {
&amp;quot;local&amp;quot;: {
&amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
}
},
&amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
&amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
}
}
}
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
}
}
],
&amp;quot;tracing&amp;quot;: {
&amp;quot;clientSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;randomSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
},
&amp;quot;overallSampling&amp;quot;: {
&amp;quot;value&amp;quot;: 100
}
},
&amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
&amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
&amp;quot;accessLog&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
&amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
&amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
}
}
],
&amp;quot;useRemoteAddress&amp;quot;: false,
&amp;quot;generateRequestId&amp;quot;: true,
&amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
&amp;quot;setCurrentClientCertDetails&amp;quot;: {
&amp;quot;subject&amp;quot;: true,
&amp;quot;dns&amp;quot;: true,
&amp;quot;uri&amp;quot;: true
},
&amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
{
&amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
}
],
&amp;quot;normalizePath&amp;quot;: true
}
}
],
&amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_9080&amp;quot;
}
],
&amp;quot;listenerFilters&amp;quot;: &amp;amp;#91;
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.listener.original_dst&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.original_dst.v2.OriginalDst&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.listener.tls_inspector&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.tls_inspector.v2.TlsInspector&amp;quot;
}
},
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.listener.http_inspector&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.http_inspector.v2.HttpInspector&amp;quot;
}
}
],
&amp;quot;listenerFiltersTimeout&amp;quot;: &amp;quot;1s&amp;quot;,
&amp;quot;continueOnListenerFiltersTimeout&amp;quot;: true,
&amp;quot;trafficDirection&amp;quot;: &amp;quot;INBOUND&amp;quot;
}
]
&lt;/code>&lt;/pre>&lt;p>Check more istio practice detail at my tech blog &lt;a href="https://cnadn.net">https://cnadn.net&lt;/a>&lt;/p></description></item><item><title>F5 BIG-IP links Istio to enhance ingress service capabilities</title><link>http://linjing.io/post/f5-istio-work-together/</link><pubDate>Mon, 22 Jun 2020 00:00:00 +0000</pubDate><guid>http://linjing.io/post/f5-istio-work-together/</guid><description>&lt;p>In the Istio system, in order to ensure the unity of policy coordination and experience, users will consider using Istio&amp;rsquo;s own Ingressgateway as the entrance to north-south traffic. Ingressgateway is generally deployed by deployment of multiple pods, scattered on multiple nodes of the cluster, depending on Due to the specific exposure type, especially in on-prem deployment, it is still necessary to deploy relevant load balancers outside the k8s cluster to load balance these ingressgateways, on the one hand, it can avoid access difficulties and operation and maintenance difficulties caused by multiple entrances. On the other hand, the high-performance and high-reliability F5 BIGIP can provide more function control and security value-added services for k8s cluster entrance traffic, which is similar to the Ingress controller.&lt;/p>
&lt;p>Unlike exposing ordinary service svc to external BIG-IP, ingressgateway itself is a collection point of various service ports. It may itself listen to many ports, so it is not easy to treat ingressgateway as a single ordinary svc. This article mainly explains how to combine Istio ingressgateway with BIG-IP to enhance the entrance business capability.&lt;/p>
&lt;p>The possible methods on the network structure are:&lt;/p>
&lt;p>External load balancer &amp;mdash; access to &amp;ndash;&amp;gt; ingressgateway&amp;rsquo;s nodeport port&lt;/p>
&lt;p>External load balancer &amp;mdash; access to &amp;ndash;&amp;gt; ingressgateway direct endpoints port (direct to pod)&lt;/p>
&lt;p>From the point of view of performance, it is naturally the second direct pod method mentioned above that has better performance, depending on the network model of the k8s cluster. If the external and pod can be directly routed or the two-layer direct connection is naturally the easiest, if it cannot be directly routed, it needs to be based on vxlan and other tunnels to achieve pod direct. F5 BIGIP supports Layer 2 direct, dynamic routing or vxlan tunnel mode. Refer to this article for detailed network deployment structure , or search for related articles in this blog. In the following, we assume that F5 BIGIP has implemented vxlan with k8s cluster, which can reach the pod directly. The final data path is as follows:&lt;/p>
&lt;p>&lt;strong>client&amp;ndash;&amp;gt;F5BIGIP&amp;ndash;&amp;gt;Istio ingressgateway pod&amp;ndash;&amp;gt;endpoints&lt;/strong>&lt;/p>
&lt;p>The underlying implementation of Istio Ingressgateway is envoy. When we publish a service to Ingressgateway through Gateway+VirtualService resource, Ingressgateway will listen to the port specified in Gateway. Therefore, once a new service is released, there may be a new listening port. However, when we deploy the ingressgateway pod, we will not configure all the external mappings in advance. That is to say, the port that the container in the pod listens to is not configured in the deployment of the pod. Don’t worry, it can be directly accessed at this time. This listening port on the pod, although the deployment port is not specified in advance.&lt;/p>
&lt;p>So how to load balance for Ingressgateway through BIGIP and dynamically discover these new monitoring services? The answer is naturally the solution described in this article. F5 BIGIP provides a controller that runs inside k8s and automatically pushes these changes to BIGIP. on. Since the same k8s svc contains one more port, you need to pay attention to the servicePort parameter when publishing this k8s svc to F5. The specific publishing process refers to the following steps:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Deploy Istio Gateway+VirtualService resources&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Edit the k8s svc corresponding to the existing Ingressgateway and add new port and target port configurations&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Configure a new F5 configmap resource and specify the corresponding servicePort to publish the new service&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="demo">DEMO:&lt;/h2>
&lt;ol>
&lt;li>First check the existing Ingressgateway pod ports are as follows, port 32400 is not exposed in the container port&lt;/li>
&lt;/ol>
&lt;pre>&lt;code> name: istio-proxy
ports:
- containerPort: 15020
protocol: TCP
- containerPort: 8080
protocol: TCP
- containerPort: 8443
protocol: TCP
- containerPort: 31400
protocol: TCP
- containerPort: 15443
protocol: TCP
- containerPort: 15011
protocol: TCP
- containerPort: 15012
protocol: TCP
- containerPort: 8060
protocol: TCP
- containerPort: 853
protocol: TCP
- containerPort: 15090
name: http-envoy-prom
protocol: TCP
&lt;/code>&lt;/pre>&lt;ol start="2">
&lt;li>Deploy Istio Gateway and VirtualService&lt;/li>
&lt;/ol>
&lt;pre>&lt;code>apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
name: tcp-echo-gateway
spec:
selector:
istio: ingressgateway
servers:
- port:
number: 32400
name: tcp
protocol: TCP
hosts:
- &amp;quot;*&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
name: tcp-echo-destination
spec:
host: tcp-echo
subsets:
- name: v1
labels:
version: v1
- name: v2
labels:
version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
name: tcp-echo
spec:
hosts:
- &amp;quot;*&amp;quot;
gateways:
- tcp-echo-gateway
tcp:
- match:
- port: 32400 ###########32400端口监听
route:
- destination:
host: tcp-echo
port:
number: 9000
subset: v1
&lt;/code>&lt;/pre>&lt;ol start="3">
&lt;li>After the deployment is complete, check envoy to confirm that the monitoring has been issued&lt;/li>
&lt;/ol>
&lt;pre>&lt;code> {
&amp;quot;name&amp;quot;: &amp;quot;0.0.0.0_32400&amp;quot;,
&amp;quot;address&amp;quot;: {
&amp;quot;socketAddress&amp;quot;: {
&amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
&amp;quot;portValue&amp;quot;: 32400
}
},
&amp;quot;filterChains&amp;quot;: &amp;amp;#91;
{
&amp;quot;filters&amp;quot;: &amp;amp;#91;
。。。。。。。。。。省略。。。。。。。。。。
{
&amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
&amp;quot;typedConfig&amp;quot;: {
&amp;quot;@type&amp;quot;:
。。。。。
&amp;quot;cluster&amp;quot;: &amp;quot;outbound|9000|v1|tcp-echo.istio-io-tcp-traffic-shifting.svc.cluster.local&amp;quot;,
。。。。。
}
}
]
}
],
&amp;quot;trafficDirection&amp;quot;: &amp;quot;OUTBOUND&amp;quot;
},
&lt;/code>&lt;/pre>&lt;ol start="4">
&lt;li>Modify the existing Ingressgateway svc, increase the external exposure of 32400 port&lt;/li>
&lt;/ol>
&lt;pre>&lt;code>kubectl edit svc istio-ingressgateway -n istio-system -o yaml
修改前：
ports:
- name: status-port
nodePort: 31702
port: 15020
protocol: TCP
targetPort: 15020
- name: http2
nodePort: 31547
port: 80
protocol: TCP
targetPort: 8080
- name: https
nodePort: 31956
port: 443
protocol: TCP
targetPort: 8443
- name: tcp
nodePort: 30775
port: 31400
protocol: TCP
targetPort: 31400
- name: tls
nodePort: 30536
port: 15443
protocol: TCP
targetPort: 15443
selector:
app: istio-ingressgateway
istio: ingressgateway
sessionAffinity: None
type: LoadBalancer
修改后：
ports:
- name: status-port
nodePort: 31702
port: 15020
protocol: TCP
targetPort: 15020
- name: http2
nodePort: 31547
port: 80
protocol: TCP
targetPort: 8080
- name: https
nodePort: 31956
port: 443
protocol: TCP
targetPort: 8443
- name: tcp
nodePort: 30775
port: 31400
protocol: TCP
targetPort: 31400
- name: tcp2
nodePort: 30776
port: 32400
protocol: TCP
targetPort: 32400 #########新增端口
- name: tls
nodePort: 30536
port: 15443
protocol: TCP
targetPort: 15443
root@k8s-master-v1-16 ~]# kubectl get svc -n istio-system
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE
grafana ClusterIP 10.96.165.101 &amp;amp;lt;none&amp;gt; 3000/TCP 2d
istio-egressgateway ClusterIP 10.110.88.185 &amp;amp;lt;none&amp;gt; 80/TCP,443/TCP,15443/TCP 2d
istio-ingressgateway LoadBalancer 10.96.122.225 &amp;amp;lt;pending&amp;gt; 15020:31702/TCP,80:31547/TCP,443:31956/TCP,31400:30775/TCP,32400:30776/TCP,15443:30536/TCP 2d
istiod ClusterIP 10.102.252.88 &amp;amp;lt;none&amp;gt; 15010/TCP,15012/TCP,443/TCP,15014/TCP,53/UDP,853/TCP 2d
jaeger-agent ClusterIP None &amp;amp;lt;none&amp;gt; 5775/UDP,6831/UDP,6832/UDP 2d
jaeger-collector ClusterIP 10.105.130.171 &amp;amp;lt;none&amp;gt; 14267/TCP,14268/TCP,14250/TCP 2d
jaeger-collector-headless ClusterIP None &amp;amp;lt;none&amp;gt; 14250/TCP 2d
jaeger-query ClusterIP 10.99.139.251 &amp;amp;lt;none&amp;gt; 16686/TCP 2d
kiali ClusterIP 10.101.189.237 &amp;amp;lt;none&amp;gt; 20001/TCP 2d
prometheus ClusterIP 10.109.157.108 &amp;amp;lt;none&amp;gt; 9090/TCP 2d
tracing ClusterIP 10.101.62.56 &amp;amp;lt;none&amp;gt; 80/TCP 2d
zipkin ClusterIP 10.98.181.246 &amp;amp;lt;none&amp;gt; 9411/TCP
&lt;/code>&lt;/pre>&lt;ol start="5">
&lt;li>Publish the 32400 servicePort to F5, at this time you need to add an F5 configmap, pay attention to the Chinese comments&lt;/li>
&lt;/ol>
&lt;pre>&lt;code>kind: ConfigMap
apiVersion: v1
metadata:
name: istio-ingressgateway.32400.vs
namespace: istio-system
labels:
f5type: virtual-server
data:
# See the f5-schema table for schema-controller compatibility
# https://clouddocs.f5.com/containers/latest/releases_and_versioning.html#f5-schema
schema: &amp;quot;f5schemadb://bigip-virtual-server_v0.1.7.json&amp;quot;
data: |
{
&amp;quot;virtualServer&amp;quot;: {
&amp;quot;backend&amp;quot;: {
&amp;quot;serviceName&amp;quot;: &amp;quot;istio-ingressgateway&amp;quot;,
&amp;quot;servicePort&amp;quot;: 32400
####It is important here. The port of the corresponding k8s svc is filled in here. The F5 CIS controller will automatically find the targetPort (CIS cluster mode) or nodeport (CIS nodeport mode) corresponding to the servicePort
},
&amp;quot;frontend&amp;quot;: {
&amp;quot;virtualAddress&amp;quot;: {
&amp;quot;port&amp;quot;: 31400,
&amp;quot;bindAddr&amp;quot;: &amp;quot;172.16.100.195&amp;quot;
},
&amp;quot;partition&amp;quot;: &amp;quot;k8s&amp;quot;,
&amp;quot;balance&amp;quot;: &amp;quot;least-connections-member&amp;quot;,
&amp;quot;mode&amp;quot;: &amp;quot;tcp&amp;quot;
}
}
}
&lt;/code>&lt;/pre>&lt;p>F5 will automatically generate the following configuration in the red box:&lt;/p>
&lt;p>&lt;img src="https://www.cnadn.net/upload/2020/06/1592839169293-1024x418.jpg?v=1592839202" alt="F5 will automatically generate the following configuration in the red box:">&lt;/p>
&lt;p>Simulate access to the business from the outside, you can see that it can be accessed normally&lt;/p>
&lt;pre>&lt;code># jlin @ Mac in ~ &amp;amp;#91;myf5.net]
$ for i in {1..2000}; do (date; sleep 1) | nc istiobookinfo.lab.f5se.io 32400; done
one Mon Jun 22 22:24:17 CST 2020
one Mon Jun 22 22:24:18 CST 2020
one Mon Jun 22 22:24:19 CST 2020
&lt;/code>&lt;/pre>&lt;p>At this point, the newly released service monitor on Istio Ingressgateway is successfully automatically posted to BIGIP. Users only need to access BIGIP&amp;rsquo;s VS to access services within k8s (on Istio Ingressgateway).&lt;/p>
&lt;p>For the subsequent release of other new port services, repeat the above steps.&lt;/p>
&lt;blockquote>
&lt;p>Note: The above configuration uses the non-F5 AS3 configmap configuration method, if you are using CIS 2.0, you need to pay attention to this issue
&lt;a href="https://github.com/F5Networks/k8s-bigip-ctlr/issues/1341">https://github.com/F5Networks/k8s-bigip-ctlr/issues/1341&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Check more istio practice detail at my tech blog &lt;a href="https://cnadn.net">https://cnadn.net&lt;/a>&lt;/p></description></item></channel></rss>